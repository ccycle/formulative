{-# LANGUAGE DeriveAnyClass #-}
{-# LANGUAGE UndecidableInstances #-}

module Test.DynamicEff where

import Control.Algebra
import Control.Carrier.Reader
import Control.Carrier.State.Strict
import Control.Effect.Sum
import GHC.Generics
import GHC.Natural
import OptDEC.Calculation.Algebra.Arithmetic.Class
import OptDEC.Calculation.DifferentialEquation.Types
import OptDEC.Calculation.Internal.Class
import OptDEC.Calculation.Optimization.LineSearch
import OptDEC.Calculation.VectorSpace.Class
import Test.Tasty

data StateTest = MkTestData {position :: Double, momentum :: Double}
  deriving (Show, Generic)
  deriving anyclass (Additive, AdditiveGroup, VectorSpace, NormSpace, InnerProductSpace)

data GlobalQuantity = MkGlobalQuantity {energy :: Double, internalEnergy :: Double}

data ConstantsOfSystem = MkConstantsOfSystem {k :: Double, gamma :: Double}

deltaL
  (MkStepSize dt)
  (MkConstantsOfSystem k gamma)
  (MkTestData x v)
  (MkTestData xNew vNew) = delta <.> gradL
   where
    gradL =
      gradDeltaL
        (MkStepSize dt)
        (MkConstantsOfSystem k gamma)
        (MkTestData x v)
        (MkTestData xNew vNew)
    delta = MkTestData (xNew .-. x) (vNew .-. v)

gradDeltaL
  (MkStepSize dt)
  (MkConstantsOfSystem k gamma)
  (MkTestData x v)
  (MkTestData xNew vNew) = MkTestData dLdx dLdv
   where
    deltaX = xNew .-. x
    dxdt = deltaX ./ dt
    deltaV = vNew .-. v
    dvdt = deltaV ./ dt
    dLdx = (k ./. 2) *. (xNew .+. x) .+. (dxdt .-. (vNew .+. v) ./ 2)
    dLdv = dvdt ./ dt .+. ((k ./. 2) *. (xNew .+. x) .+. (gamma ./. 2) *. (vNew .+. v))

instance (Member (Reader ConstantsOfSystem) sig, Algebra sig m) => HasConstantsOfSystemM m ConstantsOfSystem where
  getConstantsOfSystemM = ask

instance (Algebra sig m, Member (State StateTest) sig, Member (Reader ConstantsOfSystem) sig, Member (Reader (StepSize Double)) sig) => HasObjectiveFunctionM m StateTest where
  getObjectiveFunctionM = do
    dt <- ask
    eqParam <- getConstantsOfSystemM
    deltaL dt eqParam <$> get

instance (Algebra sig m, Member (State StateTest) sig, Member (Reader ConstantsOfSystem) sig, Member (Reader (StepSize Double)) sig) => HasGradObjectiveFunctionM m StateTest where
  getGradientOfObjectiveFunctionM = do
    dt <- ask
    eqParam <- getConstantsOfSystemM
    gradDeltaL dt eqParam <$> get

instance (Algebra sig m) => HasInitialConditionM m StateTest where
  getInitialConditionM =
    return $ MkTestData 1 0

-- mainCalc = do mainCalculationDynamic